name: Build
on: [push, pull_request]
jobs:
  build:
    name: Test compiling examples for esp8266
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Checkout custom ESPAsyncWebServer
      uses: actions/checkout@v2
      with:
        repository: Aircoookie/ESPAsyncWebServer
        ref: master
        path: CustomESPAsyncWebServer # must contain string "Custom"

    - name: Checkout custom ESPAsyncTCP
      uses: actions/checkout@v2
      with:
        repository: me-no-dev/ESPAsyncTCP
        ref: master
        path: CustomESPAsyncTCP
        
    - name: Checkout custom ESPAsyncUDP
      uses: actions/checkout@v2
      with:
        repository: me-no-dev/ESPAsyncUDP
        ref: master
        path: CustomESPAsyncUDP

    - name: Compile all examples      
      uses: ArminJo/arduino-test-compile@v2
      with:
        arduino-board-fqbn: esp8266:esp8266:d1_mini:CpuFrequency=80,VTable=flash,FlashSize=4M1M,LwIPVariant=v2mss536,Debug=Disabled,DebugLevel=None____,FlashErase=sdk,UploadSpeed=921600
        platform-url: https://arduino.esp8266.com/stable/package_esp8266com_index.json
        required-libraries: FastLED,NeoPixelBus by Makuna,IRRemoteESP8266
        build-properties: '{}'
        sketch-name: "wled00.ino"
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
    - name: Upload Release Asset
      id: upload-release-asset 
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }} # This pulls from the CREATE RELEASE step above, referencing it's ID to get its outputs object, which include a `upload_url`. See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps 
        asset_path: ./my-artifact.zip
        asset_name: my-artifact.zip
        asset_content_type: application/zip
